<div class="notice-container">
  <!-- 头部 -->
  <div class="notice-header">
    <div class="header-title">
      <span nz-icon nzType="bell" nzTheme="outline"></span>
      <span class="title-text">{{ 'notice.center' | translate }}</span>
    </div>
    <div class="header-actions">
      @if (selectedChannelIndex === 0 && messages.length > 0) {
          <button nz-button
                  nzType="link"
                  nzSize="small"
                  (click)="markAllAsRead()"
                  class="read-all-btn">
              {{ 'notice.readAll' | translate }}
          </button>
      }
      <button nz-button nzType="text" nzSize="small" (click)="close()" class="close-btn">
        <span nz-icon nzType="close"></span>
      </button>
    </div>
  </div>

  <!-- 消息列表视图 -->
  <div class="notice-content">
    <div class="channel-segmented">
      <div class="channel-header">
        <nz-segmented [nzBlock]="true"
          [nzOptions]="channelOptions"
          [(ngModel)]="selectedChannelIndex"
          (ngModelChange)="onChannelChange($event)"
          [nzSize]="'small'">
        </nz-segmented>
      </div>
    </div>

    <div class="search-box">
      <nz-input-group [nzSuffix]="suffixIconSearch">
        <input type="search" [nzSize]="'small'"
          nz-input
          [(ngModel)]="searchKeyword"
          (keyup.enter)="onSearch(searchKeyword)"
          [placeholder]="'gobal.search' | translate"/>
      </nz-input-group>
      <ng-template #suffixIconSearch>
        <span nz-icon nzType="search" (click)="onSearch(searchKeyword)" style="cursor: pointer"></span>
      </ng-template>
      @if (selectedChannelIndex === 0) {
        <label nz-checkbox [(ngModel)]="onlyUnread" (ngModelChange)="onOnlyUnreadChange($event)" style="margin-left: 8px;white-space: nowrap">
          {{ 'notice.unread' | translate }}
        </label>
      }
    </div>

    <!-- 消息列表 -->
    <nz-list [nzDataSource]="messages" [nzLoading]="loadingMessages" [nzSize]="'small'"
      class="message-list">
      @for (item of messages; track item) {
        <nz-list-item
          (click)="selectedChannelIndex === 0 ? viewMessageDetail(item) : viewAnnouncementDetail(item)"
          class="message-item">
          <div style="width: 100%">
            <div class="message-header">
              <h3 class="message-title">
                <div style="display: flex;align-items: center;">
                  <!-- 通知消息显示未读标记 -->
                  @if (selectedChannelIndex === 0 && item.status == NoticeStatus.UNREAD) {
                    <nz-badge nzStatus="error"></nz-badge>
                  }
                  <!-- 根据类型显示标题 -->
                  <span>{{ selectedChannelIndex === 0 ? item.noticeLog?.title : item.title }}</span>
                  <!-- URL 图标 -->
                  @if (selectedChannelIndex === 0 && item.noticeLog?.url) {
                    <span nz-icon
                      nzType="link"
                      nzTheme="outline"
                      (click)="openUrlDrawer(item.noticeLog.url, item.noticeLog.title || ''); $event.stopPropagation()"
                      style="margin-left: 8px; cursor: pointer; color: #1890ff;"
                      nz-tooltip>
                    </span>
                  }
                  <!-- 根据类型显示时间 -->
                  <span style="font-size: .7em;margin-left: auto">
                    {{ (selectedChannelIndex === 0 ? item.noticeLog?.createTime : item.createTime) | date:'yyyy-MM-dd HH:mm:ss' }}
                  </span>
                </div>
              </h3>
            </div>
            <!-- 根据类型显示内容 -->
            @if (selectedChannelIndex === 0 ? item.noticeLog?.content : item.content) {
              <p class="message-content"
                [innerHTML]="(selectedChannelIndex === 0 ? item.noticeLog?.content : item.content) | safeHtml">
              </p>
            }
          </div>
        </nz-list-item>
      }
    </nz-list>

    <!-- 分页 -->
    @if (total > 0) {
      <div class="notice-pagination">
        <nz-space>
          <button *nzSpaceItem nz-button nzSize="small" (click)="onPageIndexChange(pageIndex - 1)" [disabled]="pageIndex <= 1">
            <span nz-icon nzType="left"></span>
            {{ 'global.previous_page' | translate }}
          </button>
          <button *nzSpaceItem nz-button nzSize="small" (click)="onPageIndexChange(pageIndex + 1)" [disabled]="pageIndex * pageSize >= total">
            {{ 'global.next_page' | translate }}
            <span nz-icon nzType="right"></span>
          </button>
        </nz-space>
      </div>
    }
  </div>

</div>
