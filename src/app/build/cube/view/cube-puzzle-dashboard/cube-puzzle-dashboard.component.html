<div class="cube-puzzle-container" [style.height]="isFillRoute ? '100vh' : 'calc(100vh - 50px)'">
    <div class="puzzle-header">
        <div class="header-left">
            <button nz-button nzType="text" style="margin-right: 10px">
                <nz-icon nzType="close"></nz-icon>
            </button>
            <span class="dashboard-title">{{ dashboard?.name }}</span>
            @if (dashboard?.description) {
                <span nz-icon nzType="info-circle" nzTheme="outline" nz-tooltip
                      [nzTooltipTitle]="dashboard?.description"
                      class="dashboard-description-icon"></span>
            }
        </div>
        <div class="header-center">
            @if (edit) {
                <div class="action-buttons">
                    <button nz-button nzType="default" (click)="addItem()">
                        <span nz-icon nzType="plus"></span> Add Report
                    </button>
                    <button nz-button nzType="default" (click)="addFilter()">
                        <span nz-icon nzType="filter"></span> Add Filter
                    </button>
                </div>
            }
        </div>
        <div class="header-right">
            @if (edit) {
                <button nz-button nzType="default" (click)="cancelEdit()">Cancel</button>
                <button nz-button nzType="primary" (click)="saveEdit()" [nzLoading]="saving">
                    <span nz-icon nzType="save"></span> Save
                </button>
            } @else {
                <button nz-button nzType="primary" (click)="startEdit()">
                    <span nz-icon nzType="edit"></span> Edit
                </button>
            }
        </div>
    </div>
    @if (cubeMeta && dsl?.filters?.length) {
        <div class="puzzle-filter-row">
            <div class="filter-items">
                @for (filter of dsl.filters; track $index) {
                    <div class="filter-item">
                        <span class="filter-label">{{ getFieldTitle(filter.field) }}</span>
                        <span style="margin-right: 4px; color: #888;">{{ filter.operator }}</span>
                        <input nz-input [(ngModel)]="filter.value" [placeholder]="'Value'"
                               style="width: 120px" nzSize="small"/>
                        @if (edit) {
                            <button nz-button nzType="text" nzDanger nzSize="small" (click)="removeFilter($index)">
                                <span nz-icon nzType="close"></span>
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
    }
    <div class="gridster-wrapper">
        <gridster [options]="options">
            @if (dsl?.reports) {
                @for (report of dsl.reports; track $index) {
                    <gridster-item [item]="report">
                        <div class="puzzle-item">
                            @if (edit) {
                                <div class="drag-handler item-actions" title="Drag" style="left: 5px;right: auto">
                                    <button nz-button nzType="text" nzSize="small">
                                        <span nz-icon nzType="holder" nzTheme="outline"></span>
                                    </button>
                                </div>
                                <div class="item-actions">
                                    <button nz-button nzType="text" nzSize="small" (click)="editItem(report)"
                                            title="Edit">
                                        <span nz-icon nzType="edit"></span>
                                    </button>
                                    <button nz-button nzType="text" nzSize="small" nzDanger (click)="removeItem($index)"
                                            title="Remove">
                                        <span nz-icon nzType="delete"></span>
                                    </button>
                                </div>
                            } @else {
                                <div class="item-actions">
                                    <button nz-button nzType="text" nzSize="small">
                                        <span nz-icon nzType="redo"></span>
                                    </button>
                                </div>
                            }
                            <div class="puzzle-content" style="background-color: var(--ant-primary-1)">
                                <cube-puzzle-report [report]="report" [dashboard]="dashboard"/>
                            </div>
                        </div>
                    </gridster-item>
                }
            }
        </gridster>
    </div>
    <ng-template #filterAddTpl>
        <div>
            <div style="margin-bottom: 16px;">
                <div style="margin-bottom: 8px;">Field</div>
                <nz-select [(ngModel)]="addingFilter.field" style="width: 100%;" nzShowSearch
                           nzPlaceHolder="Select field">
                    <nz-option-group nzLabel="Dimensions">
                        @for (dim of cubeMeta.dimensions; track dim.code) {
                            @if (!dim.hidden) {
                                <nz-option [nzLabel]="dim.title + ' (' + dim.code + ')'"
                                           [nzValue]="dim.code"></nz-option>
                            }
                        }
                    </nz-option-group>
                    <nz-option-group nzLabel="Measures">
                        @for (mea of cubeMeta.measures; track mea.code) {
                            @if (!mea.hidden) {
                                <nz-option [nzLabel]="mea.title + ' (' + mea.code + ')'"
                                           [nzValue]="mea.code"></nz-option>
                            }
                        }
                    </nz-option-group>
                </nz-select>
            </div>

            <div style="margin-bottom: 16px;">
                <div style="margin-bottom: 8px;">Operator</div>
                <nz-select [(ngModel)]="addingFilter.operator" style="width: 100%;">
                    @for (op of operators; track op.value) {
                        <nz-option [nzLabel]="op.label" [nzValue]="op.value"></nz-option>
                    }
                </nz-select>
            </div>

            <div style="margin-bottom: 8px;">
                <div style="margin-bottom: 8px;">Default Value</div>
                <input nz-input [(ngModel)]="addingFilter.value" placeholder="Enter default value"/>
            </div>
        </div>
    </ng-template>
</div>
