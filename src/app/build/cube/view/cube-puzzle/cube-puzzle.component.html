<div class="cube-puzzle-container" [style.height]="isFillRoute ? '100vh' : 'calc(100vh - 50px)'">
    <div class="puzzle-header">
        <div class="header-left">
            <button nz-button nzType="text" style="margin-right: 10px">
                <nz-icon nzType="close"></nz-icon>
            </button>
            <span class="dashboard-title">{{ dashboard?.name }}</span>
            @if (dashboard?.description) {
                <span nz-icon nzType="info-circle" nzTheme="outline" nz-tooltip
                      [nzTooltipTitle]="dashboard?.description"
                      class="dashboard-description-icon"></span>
            }
        </div>
        <div class="header-center">
            @if (edit) {
                <div class="action-buttons">
                    <button nz-button nzType="default" (click)="addItem()">
                        <span nz-icon nzType="plus"></span> Add Report
                    </button>
                    <button nz-button nzType="default" (click)="addFilter()">
                        <span nz-icon nzType="filter"></span> Add Filter
                    </button>
                </div>
            }
        </div>
        <div class="header-right">
            @if (edit) {
                <button nz-button nzType="default" (click)="cancelEdit()">Cancel</button>
                <button nz-button nzType="primary" (click)="saveEdit()" [nzLoading]="saving">
                    <span nz-icon nzType="save"></span> Save
                </button>
            } @else {
                <button nz-button nzType="primary" (click)="startEdit()">
                    <span nz-icon nzType="edit"></span> Edit
                </button>
            }
        </div>
    </div>
    @if (cubeMeta && activeFilterCodes.size > 0) {
        <div class="puzzle-filter-row">
            <div class="filter-items">
                @for (dim of cubeMeta.dimensions; track dim.code) {
                    @if (!dim.hidden && activeFilterCodes.has(dim.code)) {
                        <div class="filter-item">
                            <span class="filter-label">{{ dim.title }}</span>
                            <nz-select nzShowSearch nzAllowClear [nzPlaceHolder]="'Select ' + dim.title"
                                       [(ngModel)]="filters[dim.code]"
                                       style="width: 150px" nzSize="small">
                                <!-- 暂时留空，后续对接数据 -->
                            </nz-select>
                        </div>
                    }
                }
                @for (mea of cubeMeta.measures; track mea.code) {
                    @if (!mea.hidden && activeFilterCodes.has(mea.code)) {
                        <div class="filter-item">
                            <span class="filter-label">{{ mea.title }}</span>
                            <nz-select nzShowSearch nzAllowClear [nzPlaceHolder]="'Select ' + mea.title"
                                       [(ngModel)]="filters[mea.code]"
                                       style="width: 150px" nzSize="small">
                                <!-- 暂时留空，后续对接数据 -->
                            </nz-select>
                        </div>
                    }
                }
            </div>
        </div>
    }
    <div class="gridster-wrapper">
        <gridster [options]="options">
            @if (dsl?.reports) {
                @for (report of dsl.reports; track $index) {
                    <gridster-item [item]="report">
                        <div class="puzzle-item">
                            @if (edit) {
                                <div class="drag-handler item-actions" title="Drag" style="left: 5px;right: auto">
                                    <button nz-button nzType="text" nzSize="small">
                                        <span nz-icon nzType="holder" nzTheme="outline"></span>
                                    </button>
                                </div>
                                <div class="item-actions">
                                    <button nz-button nzType="text" nzSize="small" (click)="editItem(report)" title="Edit">
                                        <span nz-icon nzType="edit"></span>
                                    </button>
                                    <button nz-button nzType="text" nzSize="small" nzDanger (click)="removeItem($index)"
                                            title="Remove">
                                        <span nz-icon nzType="delete"></span>
                                    </button>
                                </div>
                            } @else {
                                <div class="item-actions">
                                    <button nz-button nzType="text" nzSize="small">
                                        <span nz-icon nzType="redo"></span>
                                    </button>
                                </div>
                            }
                            <div class="puzzle-content" style="background-color: var(--ant-primary-1)">
                                <nz-card [nzTitle]="report.title" nzSize="small" style="height: 100%;margin-bottom: 0">
                                    {{report | json}}
                                </nz-card>
                            </div>
                        </div>
                    </gridster-item>
                }
            }
        </gridster>
    </div>
    <ng-template #transferTpl>
        <nz-transfer
            [nzDataSource]="transferList"
            [nzTitles]="['Available', 'Selected']"
            (nzChange)="transferChange($event)">
        </nz-transfer>
    </ng-template>
</div>
