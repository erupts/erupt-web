<div class="flow-approval-container">
    <!-- 左侧导航栏 -->
    <div class="sidebar" [class.collapsed]="sidebarCollapsed">
        <!-- 移动端头部 -->
        <div class="sidebar-header">
            <div class="search-section">
                <span nz-icon nzType="search" nzTheme="outline"></span>
                <span class="search-text">搜索审批</span>
            </div>
        </div>

        <div class="navigation-menu">
            <ul nz-menu
                nzMode="inline"
                [nzInlineCollapsed]="sidebarCollapsed"
                class="approval-menu">

                <!-- 待办 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.TODO)" [nzSelected]="ApprovalView.TODO === selectedView">
                    <div style="display: flex;align-items: center">
                        <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
                        <span class="menu-title">待办</span>
                        <nz-badge style="margin-left:auto" [nzCount]="5" nzShowZero class="menu-badge"></nz-badge>
                    </div>
                </li>
                <!-- 已办 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.DONE)" [nzSelected]="ApprovalView.DONE === selectedView">
                    <span nz-icon nzType="check-circle" nzTheme="outline"></span>
                    <span class="menu-title">已办</span>
                </li>

                <!-- 抄送我 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.CC)" [nzSelected]="ApprovalView.CC === selectedView">
                    <span nz-icon nzType="copy" nzTheme="outline"></span>
                    <span class="menu-title">抄送我</span>
                </li>

                <!-- 已发起 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.CREATED)" [nzSelected]="ApprovalView.CREATED === selectedView">
                    <span nz-icon nzType="rocket" nzTheme="outline"></span>
                    <span class="menu-title">已发起</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
        <!-- 中间列表区域 -->
        <div class="list-section">
            <div class="list-header">
                <div class="time-filter">
                    <span>所有时间</span>
                    <span nz-icon nzType="down" nzTheme="outline"></span>
                </div>
                <div class="separator"></div>
                <button nz-button nzType="text" nzSize="small">
                    <span nz-icon nzType="more" nzTheme="outline"></span>
                </button>
            </div>

            <div class="approval-list">
                <div
                    class="approval-item"
                    *ngFor="let item of flowInstance"
                    [class.active]="item?.id === selectedInstance?.id"
                    (click)="selectItem(item)"
                >
                    <div class="item-header">
                        <h3 class="item-title">{{ item.eruptFlowConfig.name }}</h3>
                        <nz-tag
                            [nzColor]="getStatusColor(item.status)"
                            class="status-tag"
                        >
                            {{ item.status }}
                        </nz-tag>
                    </div>
                    <div class="item-footer">
                        <div class="submitter-info">
                            <div class="avatar" [style.background-color]="item.eruptFlowConfig.color">
                                {{ item.initiatorUser.name[0] }}
                            </div>
                            <span class="submitter-name">{{ item.initiatorUser.name }}</span>
                        </div>
                        <div class="time-info">
                            <span class="process-time" *ngIf="item.finishTime">处理时间 {{ item.finishTime }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧详情区域 -->
        <div class="detail-section" *ngIf="selectedInstance; else emptyDetail">
            <div class="detail-header">
                <div class="header-left">
                    <span class="item-id">编号: {{ selectedInstance?.no }}</span>
                </div>
                <div class="header-right">
                    <button nz-button nzType="text" nzSize="small" nz-tooltip nzTooltipTitle="链接">
                        <span nz-icon nzType="link" nzTheme="outline"></span>
                    </button>
                    <button nz-button nzType="text" nzSize="small" nz-tooltip nzTooltipTitle="刷新">
                        <span nz-icon nzType="reload" nzTheme="outline"></span>
                    </button>
                    <button nz-button nzType="text" nzSize="small" nz-tooltip nzTooltipTitle="打印">
                        <span nz-icon nzType="printer" nzTheme="outline"></span>
                    </button>
                </div>
            </div>

            <div class="detail-content" *ngIf="selectedInstance">
                <div class="content-header">
                    <h1 class="content-title">{{ selectedInstance.eruptFlowConfig.name }}</h1>
                    <nz-tag
                        [nzColor]="'#09f'"
                        class="status-tag-large"
                    >
                        {{ selectedInstance.status }}
                    </nz-tag>
                </div>

                <div class="submitter-info-large">
                    <div class="submitter-details">
                        <span class="submitter-name-large">{{ selectedInstance.initiatorUser.name }}</span>&nbsp;&nbsp;
                        <span class="submitter-dept">部门</span>&nbsp;&nbsp;
                        <span class="submit-time">提交于 {{ selectedInstance.createTime }}</span>
                    </div>
                </div>

                <!-- 标签页导航 -->
                <nz-tabset
                    class="detail-tabs"
                    (nzSelectedIndexChange)="onTabChange($event)"
                    [nzSelectedIndex]="activeTabIndex"
                >
                    <nz-tab nzTitle="审批详情">
                        <div class="tab-content">
                            <div class="section" *ngIf="instanceDetail">
                                <h3 class="section-title">| 基本信息</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">流程编号：</span>
                                        <span class="info-value">{{ instanceDetail.no || selectedInstance?.no }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">流程名称：</span>
                                        <span class="info-value">{{ instanceDetail.eruptFlowConfig?.name || selectedInstance?.eruptFlowConfig?.name }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">发起人：</span>
                                        <span class="info-value">{{ instanceDetail.initiatorUser?.name || selectedInstance?.initiatorUser?.name }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">创建时间：</span>
                                        <span class="info-value">{{ instanceDetail.createTime || selectedInstance?.createTime }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">完成时间：</span>
                                        <span class="info-value">{{ instanceDetail.finishTime || selectedInstance?.finishTime || '-' }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">状态：</span>
                                        <span class="info-value">
                                            <nz-tag [nzColor]="getStatusColor(instanceDetail.status || selectedInstance?.status)">
                                                {{ getStatusText(instanceDetail.status || selectedInstance?.status) }}
                                            </nz-tag>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section" *ngIf="nodeInfo">
                                <h3 class="section-title">| 流程节点</h3>
                                <div class="node-info">
                                    <div class="node-item">
                                        <span class="node-name">{{ nodeInfo.name }}</span>
                                        <span class="node-type">{{ nodeInfo.type }}</span>
                                    </div>
                                    <div class="node-branches" *ngIf="nodeInfo.branches && nodeInfo.branches.length > 0">
                                        <div class="branch-item" *ngFor="let branch of nodeInfo.branches">
                                            <span class="branch-name">{{ branch.name }}</span>
                                            <span class="branch-type">{{ branch.type }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nz-tab>

                    <nz-tab nzTitle="审批记录">
                        <div class="tab-content">
                            <div class="section">
                                <h3 class="section-title">| 审批记录</h3>
                                <div *ngIf="instanceTasks.length > 0; else noTasks">
                                    <nz-table
                                        #recordsTable
                                        [nzData]="instanceTasks"
                                        [nzShowPagination]="false"
                                        [nzSize]="'small'"
                                        class="records-table"
                                    >
                                        <thead>
                                        <tr>
                                            <th>审批人</th>
                                            <th>任务类型</th>
                                            <th>任务状态</th>
                                            <th>审批意见</th>
                                            <th>创建时间</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr *ngFor="let task of instanceTasks">
                                            <td>
                                                <div class="approver-info">
                                                    <div class="avatar-small"
                                                         [style.background-color]="getAvatarColor(task.assigneeUser?.name || '')">
                                                        {{ task.assigneeUser?.name?.[0] || '-' }}
                                                    </div>
                                                    <span class="approver-name">{{ task.assigneeUser?.name || '-' }}</span>
                                                </div>
                                            </td>
                                            <td>{{ task.taskType || '-' }}</td>
                                            <td>
                                                <nz-tag [nzColor]="getTaskStatusColor(task.taskStatus)">
                                                    {{ getTaskStatusText(task.taskStatus) }}
                                                </nz-tag>
                                            </td>
                                            <td>{{ task.comment || '-' }}</td>
                                            <td>
                                                <div class="time-info">
                                                    <div>{{ task.createTime | date:'yyyy-MM-dd HH:mm:ss' }}</div>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </nz-table>
                                </div>
                                <ng-template #noTasks>
                                    <nz-empty
                                        nzNotFoundImage="simple"
                                        nzNotFoundContent="暂无审批记录"
                                    ></nz-empty>
                                </ng-template>
                            </div>
                        </div>
                    </nz-tab>

                    <nz-tab [nzTitle]="'全文评论 (' + comments.length + ')'">
                        <div class="tab-content">
                            <div class="section">
                                <h3 class="section-title">| 评论列表</h3>
                                
                                <!-- 添加评论 -->
                                <div class="comment-form">
                                    <nz-input-group [nzSuffix]="commentSuffix">
                                        <input 
                                            nz-input 
                                            [(ngModel)]="newComment" 
                                            placeholder="请输入评论内容..."
                                            (keyup.enter)="submitComment()"
                                        />
                                    </nz-input-group>
                                    <ng-template #commentSuffix>
                                        <button 
                                            nz-button 
                                            nzType="primary" 
                                            nzSize="small"
                                            [disabled]="!newComment.trim() || isSubmittingComment"
                                            (click)="submitComment()"
                                        >
                                            <span nz-icon nzType="send" nzTheme="outline"></span>
                                            {{ isSubmittingComment ? '提交中...' : '发送' }}
                                        </button>
                                    </ng-template>
                                </div>

                                <!-- 评论列表 -->
                                <div class="comments-list" *ngIf="comments.length > 0; else noComments">
                                    <div class="comment-item" *ngFor="let comment of comments">
                                        <div class="comment-header">
                                            <div class="comment-user">
                                                <div class="avatar-small"
                                                     [style.background-color]="getAvatarColor(comment.createUser?.name || '')">
                                                    {{ comment.createUser?.name?.[0] || '-' }}
                                                </div>
                                                <span class="comment-username">{{ comment.createUser?.name || '-' }}</span>
                                            </div>
                                            <span class="comment-time">{{ comment.createTime | date:'yyyy-MM-dd HH:mm:ss' }}</span>
                                        </div>
                                        <div class="comment-content">
                                            {{ comment.comment }}
                                        </div>
                                    </div>
                                </div>
                                
                                <ng-template #noComments>
                                    <nz-empty
                                        nzNotFoundImage="simple"
                                        nzNotFoundContent="暂无评论内容"
                                    ></nz-empty>
                                </ng-template>
                            </div>
                        </div>
                    </nz-tab>
                </nz-tabset>
            </div>

            <!-- 固定在右侧底部的功能按钮 -->
            <div class="fixed-bottom-actions">
                <div class="action-buttons">
                    <button nz-button nzSize="default" (click)="cc()">
                        <span nz-icon nzType="send" nzTheme="outline"></span>
                        抄送
                    </button>
                    <button nz-button nzSize="default" (click)="modify()">
                        <span nz-icon nzType="edit" nzTheme="outline"></span>
                        修改
                    </button>
                    <button nz-button nzSize="default" (click)="recall()">
                        <span nz-icon nzType="undo" nzTheme="outline"></span>
                        撤销
                    </button>
                    <button nz-button nzSize="default" (click)="resubmit()">
                        <span nz-icon nzType="redo" nzTheme="outline"></span>
                        再次提交
                    </button>
                </div>
            </div>
        </div>

        <!-- 空状态模板 -->
        <ng-template #emptyDetail>
            <div class="detail-section empty-detail">
                <div class="empty-content" style="margin-top: 20%">
                    <nz-empty
                        nzNotFoundImage="simple"
                        nzNotFoundContent="请选择一个审批项目查看详情"
                    ></nz-empty>
                </div>
            </div>
        </ng-template>
    </div>
</div>
