<div class="flow-approval-container">
    <!-- 左侧导航栏 -->
    <div class="sidebar" [class.collapsed]="sidebarCollapsed">
        <!-- 移动端头部 -->
        <div class="sidebar-header">
            <div class="search-section">
                <span nz-icon nzType="search" nzTheme="outline"></span>
                <span class="search-text">搜索审批</span>
            </div>
        </div>

        <div class="navigation-menu">
            <ul nz-menu
                nzMode="inline"
                [nzInlineCollapsed]="sidebarCollapsed"
                class="approval-menu">

                <!-- 待办 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.TODO)" [nzSelected]="ApprovalView.TODO === selectedView">
                    <div style="display: flex;align-items: center">
                        <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
                        <span class="menu-title">待办</span>
                        <nz-badge style="margin-left:auto" [nzCount]="todoCount" class="menu-badge"></nz-badge>
                    </div>
                </li>
                <!-- 已办 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.DONE)" [nzSelected]="ApprovalView.DONE === selectedView">
                    <span nz-icon nzType="check-circle" nzTheme="outline"></span>
                    <span class="menu-title">已办</span>
                </li>

                <!-- 抄送我 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.CC)" [nzSelected]="ApprovalView.CC === selectedView">
                    <span nz-icon nzType="copy" nzTheme="outline"></span>
                    <span class="menu-title">抄送我</span>
                </li>

                <!-- 已发起 -->
                <li nz-menu-item (click)="onSwitchView(ApprovalView.CREATED)" [nzSelected]="ApprovalView.CREATED === selectedView">
                    <span nz-icon nzType="rocket" nzTheme="outline"></span>
                    <span class="menu-title">已发起</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="main-content">
        <!-- 中间列表区域 -->
        <div class="list-section">
            <div class="list-header">
                <div class="time-filter">
                    <span>所有时间</span>
                    <span nz-icon nzType="down" nzTheme="outline"></span>
                </div>
                <div class="separator"></div>
                <button nz-button nzType="text" nzSize="small">
                    <span nz-icon nzType="more" nzTheme="outline"></span>
                </button>
            </div>

            <div class="approval-list">
                <div
                    class="approval-item"
                    *ngFor="let item of flowInstanceTask"
                    [class.active]="item?.flowInstance?.id === selectedInstanceTask?.flowInstance?.id"
                    (click)="selectItem(item)"
                >
                    <div class="item-header">
                        <h3 class="item-title">
                            {{ item.flowInstance?.eruptFlowConfig?.name }}
                        </h3>
                        <nz-tag
                            [nzColor]="getStatusColor(item.flowInstance?.status)"
                            class="status-tag"
                            style="margin-right: 0"
                        >
                            {{ item.flowInstance?.status }}
                        </nz-tag>
                    </div>
                    <div class="item-footer">
                        <div class="submitter-info">
                            <div class="avatar" [style.background-color]="item.flowInstance?.eruptFlowConfig?.color">
                                {{ item.flowInstance?.initiatorUser?.name?.[0] }}
                            </div>
                            <span class="submitter-name">{{ item.flowInstance?.initiatorUser?.name }}</span>
                        </div>
                        <div class="time-info">
                            <span class="process-time" *ngIf="item.flowInstance?.finishTime">处理时间 {{ item.flowInstance?.finishTime }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧详情区域 -->
        <div class="detail-section" *ngIf="selectedInstanceTask; else emptyDetail">
            <div class="detail-header">
                <div class="header-left">
                                        <span class="item-id" (click)="copyToClipboard(selectedInstanceTask?.flowInstance?.no)" style="cursor: pointer;">
                       编号: {{ selectedInstanceTask?.flowInstance?.no }}
                        <span nz-icon nzType="copy" nzTheme="outline" class="copy-icon"></span>
                    </span>
                </div>
                <div class="header-right">
                    <button nz-button nzType="text" nzSize="small" nz-tooltip nzTooltipTitle="链接">
                        <span nz-icon nzType="link" nzTheme="outline"></span>
                    </button>
                    <button nz-button nzType="text" nzSize="small" nz-tooltip nzTooltipTitle="刷新" (click)="selectItem(selectedInstanceTask)">
                        <span nz-icon nzType="reload" nzTheme="outline"></span>
                    </button>
                    <button nz-button nzType="text" nzSize="small" nz-tooltip nzTooltipTitle="打印">
                        <span nz-icon nzType="printer" nzTheme="outline"></span>
                    </button>
                </div>
            </div>

            <div class="detail-content" *ngIf="selectedInstanceTask">
                <div class="content-header">
                    <h1 class="content-title">{{ selectedInstanceTask.flowInstance?.eruptFlowConfig?.name }}</h1>
                    <nz-tag
                        [nzColor]="'#09f'"
                        class="status-tag-large"
                    >
                        {{ selectedInstanceTask.flowInstance?.status }}
                    </nz-tag>
                </div>

                <div class="submitter-info-large">
                    <div class="submitter-details">
                        <span class="submitter-name-large">{{ selectedInstanceTask.flowInstance?.initiatorUser?.name }}</span>&nbsp;&nbsp;
                        <span class="submitter-dept">部门</span>&nbsp;&nbsp;
                        <span class="submit-time">提交于 {{ selectedInstanceTask.flowInstance?.createTime }}</span>
                    </div>
                </div>

                <!-- 标签页导航 -->
                <nz-tabset
                    class="detail-tabs"
                    (nzSelectedIndexChange)="onTabChange($event)"
                    [nzSelectedIndex]="activeTabIndex"
                >
                    <nz-tab nzTitle="审批信息">
                        <div class="tab-content">
                            <div class="section" *ngIf="eruptBuild">
                                <erupt-flow-form [eruptBuild]="eruptBuild" [readonly]="true"></erupt-flow-form>
                            </div>
                            <!--                            <div class="section" *ngIf="nodeInfo">-->
                            <!--                                <h3 class="section-title">流程节点</h3>-->
                            <!--                                <div class="node-info">-->
                            <!--                                    <div class="node-item">-->
                            <!--                                        <span class="node-name">{{ nodeInfo.name }}</span>-->
                            <!--                                        <span class="node-type">{{ nodeInfo.type }}</span>-->
                            <!--                                    </div>-->
                            <!--                                    <div class="node-branches" *ngIf="nodeInfo.branches && nodeInfo.branches.length > 0">-->
                            <!--                                        <div class="branch-item" *ngFor="let branch of nodeInfo.branches">-->
                            <!--                                            <span class="branch-name">{{ branch.name }}</span>-->
                            <!--                                            <span class="branch-type">{{ branch.type }}</span>-->
                            <!--                                        </div>-->
                            <!--                                    </div>-->
                            <!--                                </div>-->
                            <!--                            </div>-->
                        </div>
                    </nz-tab>

                    <nz-tab nzTitle="审批记录">
                        <div class="tab-content">
                            <div class="section">
                                <div *ngIf="instanceTasks.length > 0; else noTasks">
                                    <nz-table
                                        #recordsTable
                                        [nzData]="instanceTasks"
                                        [nzShowPagination]="false"
                                        [nzSize]="'small'"
                                        class="records-table"
                                    >
                                        <thead>
                                        <tr>
                                            <th>审批人</th>
                                            <th>任务类型</th>
                                            <th>任务状态</th>
                                            <th>审批意见</th>
                                            <th>创建时间</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr *ngFor="let task of instanceTasks">
                                            <td>
                                                <div class="approver-info">
                                                    <div class="avatar-small"
                                                         [style.background-color]="getAvatarColor(task.assigneeUser?.name || '')">
                                                        {{ task.assigneeUser?.name?.[0] || '-' }}
                                                    </div>
                                                    <span class="approver-name">{{ task.assigneeUser?.name || '-' }}</span>
                                                </div>
                                            </td>
                                            <td>{{ task.taskType || '-' }}</td>
                                            <td>
                                                <nz-tag>
                                                    {{ getTaskStatusText(task.taskStatus) }}
                                                </nz-tag>
                                            </td>
                                            <td>{{ task.comment || '-' }}</td>
                                            <td>
                                                <div class="time-info">
                                                    <div>{{ task.createTime | date:'yyyy-MM-dd HH:mm:ss' }}</div>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </nz-table>
                                </div>
                                <ng-template #noTasks>
                                    <nz-empty
                                        nzNotFoundImage="simple"
                                        nzNotFoundContent="暂无审批记录"
                                    ></nz-empty>
                                </ng-template>
                            </div>
                        </div>
                    </nz-tab>

                    <nz-tab [nzTitle]="'评论列表 (' + comments.length + ')'">
                        <div class="tab-content">
                            <div class="section">
                                <!-- 添加评论 -->
                                <div class="comment-form">
                                    <nz-input-group [nzSuffix]="commentSuffix">
                                        <input
                                            nz-input
                                            [(ngModel)]="newComment"
                                            placeholder="请输入评论内容..."
                                            (keyup.enter)="submitComment()"
                                        />
                                    </nz-input-group>
                                    <ng-template #commentSuffix>
                                        <button
                                            nz-button
                                            nzType="primary"
                                            nzSize="small"
                                            [disabled]="!newComment.trim() || isSubmittingComment"
                                            (click)="submitComment()"
                                        >
                                            <span nz-icon nzType="send" nzTheme="outline"></span>
                                            {{ isSubmittingComment ? '提交中...' : '发送' }}
                                        </button>
                                    </ng-template>
                                </div>

                                <!-- 评论列表 -->
                                <div class="comments-list" *ngIf="comments.length > 0; else noComments">
                                    <div class="comment-item" *ngFor="let comment of comments">
                                        <div class="comment-header">
                                            <div class="comment-user">
                                                <div class="avatar-small"
                                                     [style.background-color]="getAvatarColor(comment.createUser?.name || '')">
                                                    {{ comment.createUser?.name?.[0] || '-' }}
                                                </div>
                                                <span class="comment-username">{{ comment.createUser?.name || '-' }}</span>
                                            </div>
                                            <span class="comment-time">{{ comment.createTime | date:'yyyy-MM-dd HH:mm:ss' }}</span>
                                        </div>
                                        <div class="comment-content">
                                            {{ comment.comment }}
                                        </div>
                                    </div>
                                </div>

                                <ng-template #noComments>
                                    <nz-empty
                                        nzNotFoundImage="simple"
                                        nzNotFoundContent="暂无评论内容"
                                    ></nz-empty>
                                </ng-template>
                            </div>
                        </div>
                    </nz-tab>
                </nz-tabset>
            </div>

            <!-- 固定在右侧底部的功能按钮 -->
            <div class="fixed-bottom-actions">
                <div class="action-buttons">
                    <ng-container *ngIf="ApprovalView.TODO === selectedView">
                        <button nz-button nzSize="default" nzType="primary" nzGhost (click)="approve()">
                            <span nz-icon nzType="check" nzTheme="outline"></span>
                            同意
                        </button>
                        <button nz-button nzSize="default" nzDanger (click)="reject()">
                            <span nz-icon nzType="close" nzTheme="outline"></span>
                            拒绝
                        </button>

                        <button nz-button nzSize="default" (click)="cc()" *ngIf="nodeInfo?.prop?.allowCc">
                            <span nz-icon nzType="send" nzTheme="outline"></span>
                            抄送
                        </button>
                        <button nz-button nzSize="default" (click)="transfer()" *ngIf="nodeInfo?.prop?.allowTransfer">
                            <span nz-icon nzType="swap" nzTheme="outline"></span>
                            转交
                        </button>
                        <button nz-button nzSize="default" (click)="addSigner()" *ngIf="nodeInfo?.prop?.allowAddSign">
                            <span nz-icon nzType="user-add" nzTheme="outline"></span>
                            加签
                        </button>
                        <button nz-button nzSize="default" (click)="return()" *ngIf="nodeInfo?.prop?.allowReturn">
                            <span nz-icon nzType="rollback" nzTheme="outline"></span>
                            退回
                        </button>
                        <button nz-button nzSize="default" (click)="modify()">
                            <span nz-icon nzType="edit" nzTheme="outline"></span>
                            修改
                        </button>
                    </ng-container>
                    <ng-container *ngIf="ApprovalView.CREATED === selectedView">
                        <button nz-button nzSize="default" (click)="recall()">
                            <span nz-icon nzType="undo" nzTheme="outline"></span>
                            撤销
                        </button>
                        <button nz-button nzSize="default" (click)="resubmit()">
                            <span nz-icon nzType="redo" nzTheme="outline"></span>
                            再次提交
                        </button>
                    </ng-container>
                </div>
            </div>
        </div>

        <!-- 空状态模板 -->
        <ng-template #emptyDetail>
            <div class="detail-section empty-detail">
                <div class="empty-content" style="margin-top: 20%">
                    <nz-empty
                        nzNotFoundImage="simple"
                        nzNotFoundContent="请选择一个审批项目查看详情"
                    ></nz-empty>
                </div>
            </div>
        </ng-template>
    </div>
</div>

<!-- 同意弹窗 -->
<nz-modal
    [(nzVisible)]="approveModalVisible"
    nzTitle="同意审批"
    nzOkText="确定"
    nzCancelText="取消"
    (nzOnOk)="submitApprove()"
    (nzOnCancel)="approveModalVisible = false"
>
    <div *nzModalContent>
        <div class="modal-content">
            <p class="modal-description">请填写同意原因：</p>
            <nz-input-group>
                <textarea
                    nz-input
                    [(ngModel)]="approveReason"
                    placeholder="请输入同意原因..."
                    [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                    class="reason-textarea"
                ></textarea>
            </nz-input-group>
        </div>
    </div>
</nz-modal>

<!-- 拒绝弹窗 -->
<nz-modal
    [(nzVisible)]="rejectModalVisible"
    nzTitle="拒绝审批"
    nzOkText="确定"
    nzCancelText="取消"
    nzOkDanger="true"
    (nzOnOk)="submitReject()"
    (nzOnCancel)="rejectModalVisible = false"
>
    <div *nzModalContent>
        <div class="modal-content">
            <p class="modal-description">请填写拒绝原因：</p>
            <nz-input-group>
                <textarea
                    nz-input
                    [(ngModel)]="rejectReason"
                    placeholder="请输入拒绝原因..."
                    [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                    class="reason-textarea"
                ></textarea>
            </nz-input-group>
        </div>
    </div>
</nz-modal>

<!-- 抄送弹窗 -->
<nz-modal
    [(nzVisible)]="ccModalVisible"
    nzTitle="抄送审批"
    nzOkText="确定"
    nzCancelText="取消"
    (nzOnOk)="submitCc()"
    (nzOnCancel)="ccModalVisible = false"
>
    <div *nzModalContent>
        <div class="modal-content">
            <div class="form-item">
                <label class="form-label">抄送人员：</label>
                <nz-select
                    [(ngModel)]="ccUsers"
                    [nzMode]="'multiple'"
                    [nzPlaceHolder]="'请选择抄送人员'"
                    [nzShowSearch]="true"
                    [nzAllowClear]="true"
                    class="cc-user-select"
                >
                    <nz-option
                        *ngFor="let user of availableUsers"
                        [nzValue]="user.id"
                        [nzLabel]="user.name"
                    ></nz-option>
                </nz-select>
            </div>
            <div class="form-item">
                <label class="form-label">抄送说明：</label>
                <nz-input-group>
                    <textarea
                        nz-input
                        [(ngModel)]="ccReason"
                        placeholder="请输入抄送说明..."
                        [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                        class="reason-textarea"
                    ></textarea>
                </nz-input-group>
            </div>
        </div>
    </div>
</nz-modal>

<!-- 转交弹窗 -->
<nz-modal
    [(nzVisible)]="transferModalVisible"
    nzTitle="转交审批"
    nzOkText="确定"
    nzCancelText="取消"
    (nzOnOk)="submitTransfer()"
    (nzOnCancel)="transferModalVisible = false"
>
    <div *nzModalContent>
        <div class="modal-content">
            <div class="form-item">
                <label class="form-label">转交人员：</label>
                <nz-select
                    [(ngModel)]="transferUser"
                    [nzPlaceHolder]="'请选择转交人员'"
                    [nzShowSearch]="true"
                    [nzAllowClear]="true"
                    class="transfer-user-select"
                >
                    <nz-option
                        *ngFor="let user of availableUsers"
                        [nzValue]="user.id"
                        [nzLabel]="user.name"
                    ></nz-option>
                </nz-select>
            </div>
            <div class="form-item">
                <label class="form-label">转交说明：</label>
                <nz-input-group>
                    <textarea
                        nz-input
                        [(ngModel)]="transferReason"
                        placeholder="请输入转交说明..."
                        [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                        class="reason-textarea"
                    ></textarea>
                </nz-input-group>
            </div>
        </div>
    </div>
</nz-modal>

<!-- 加签弹窗 -->
<nz-modal
    [(nzVisible)]="addSignModalVisible"
    nzTitle="加签审批"
    nzOkText="确定"
    nzCancelText="取消"
    (nzOnOk)="submitAddSign()"
    (nzOnCancel)="addSignModalVisible = false"
>
    <div *nzModalContent>
        <div class="modal-content">
            <div class="form-item">
                <label class="form-label">加签类型：</label>
                <nz-radio-group [(ngModel)]="addSignType" class="add-sign-type-group">
                    <label nz-radio [nzValue]="'before'">前加签</label>
                    <label nz-radio [nzValue]="'after'">后加签</label>
                </nz-radio-group>
            </div>
            <div class="form-item">
                <label class="form-label">加签人员：</label>
                <nz-select
                    [(ngModel)]="addSignUsers"
                    [nzMode]="'multiple'"
                    [nzPlaceHolder]="'请选择加签人员'"
                    [nzShowSearch]="true"
                    [nzAllowClear]="true"
                    class="add-sign-user-select"
                >
                    <nz-option
                        *ngFor="let user of availableUsers"
                        [nzValue]="user.id"
                        [nzLabel]="user.name"
                    ></nz-option>
                </nz-select>
            </div>
            <div class="form-item">
                <label class="form-label">加签说明：</label>
                <nz-input-group>
                    <textarea
                        nz-input
                        [(ngModel)]="addSignReason"
                        placeholder="请输入加签说明..."
                        [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                        class="reason-textarea"
                    ></textarea>
                </nz-input-group>
            </div>
        </div>
    </div>
</nz-modal>

<!-- 退回弹窗 -->
<nz-modal
    [(nzVisible)]="returnModalVisible"
    nzTitle="退回审批"
    nzOkText="确定"
    nzCancelText="取消"
    nzOkDanger="true"
    (nzOnOk)="submitReturn()"
    (nzOnCancel)="returnModalVisible = false"
>
    <div *nzModalContent>
        <div class="modal-content">
            <div class="form-item">
                <label class="form-label">退回节点：</label>
                <nz-select
                    [(ngModel)]="returnNode"
                    [nzPlaceHolder]="'请选择退回节点'"
                    [nzShowSearch]="true"
                    [nzAllowClear]="true"
                    class="return-node-select"
                >
                    <nz-option
                        *ngFor="let node of availableReturnNodes"
                        [nzValue]="node.id"
                        [nzLabel]="node.name"
                    ></nz-option>
                </nz-select>
            </div>
            <div class="form-item">
                <label class="form-label">退回说明：</label>
                <nz-input-group>
                    <textarea
                        nz-input
                        [(ngModel)]="returnReason"
                        placeholder="请输入退回说明..."
                        [nzAutosize]="{ minRows: 3, maxRows: 6 }"
                        class="reason-textarea"
                    ></textarea>
                </nz-input-group>
            </div>
        </div>
    </div>
</nz-modal>
