<div class="smart-search-container">
    <!-- 标题区域 -->
    <div class="header-section">
        <div class="title-area">
            <h3 class="main-title">
                <i nz-icon nzType="info-circle" nzTheme="outline"></i>
                当满足以下条件时进入当前分支
            </h3>
            <button nz-button nzType="default" (click)="resetForm()" style="margin-left: auto">
                重置
            </button>
        </div>
    </div>

    <!-- 条件构建器 -->
    <form nz-form [formGroup]="conditionForm" class="condition-builder">
        <div class="condition-panel">
            <!-- 条件组列表 -->
            <div formArrayName="conditionGroups" class="condition-groups">
                <div
                    *ngFor="let group of conditionGroups.controls; let groupIndex = index"
                    [formGroupName]="groupIndex"
                    class="condition-group-wrapper"
                >
                    <!-- 或标识 -->
                    <div class="or-divider" *ngIf="groupIndex > 0">
                        <span class="or-text">或</span>
                    </div>

                    <!-- 条件组卡片 -->
                    <nz-card
                        [nzTitle]="cardTitle"
                        [nzExtra]="cardExtra"
                        class="condition-group-card"
                        [nzSize]="'small'"
                    >
                        <ng-template #cardTitle>
                            <span class="card-title-text">条件组 {{ groupIndex + 1 }}</span>
                        </ng-template>

                        <ng-template #cardExtra>
                            <button
                                nz-button
                                nzType="text"
                                nzSize="small"
                                nzDanger
                                (click)="removeConditionGroup(groupIndex)"
                                *ngIf="conditionGroups.length > 1"
                            >
                                <i nz-icon nzType="delete" nzTheme="outline"></i>
                            </button>
                        </ng-template>

                        <!-- 条件项列表 -->
                        <div formArrayName="conditions" class="conditions-list">
                            <div
                                *ngFor="let condition of getConditions(groupIndex).controls; let conditionIndex = index"
                                [formGroupName]="conditionIndex"
                                class="condition-item"
                            >
                                <!-- 逻辑操作符标签 -->
                                <div class="logic-label" *ngIf="conditionIndex > 0">
                                    <span class="logic-text">且</span>
                                    <button
                                        nz-button
                                        nzType="text"
                                        nzSize="small"
                                        nzDanger
                                        (click)="removeCondition(groupIndex, conditionIndex)"
                                    >
                                        <i nz-icon nzType="delete" nzTheme="outline"></i>
                                    </button>
                                </div>

                                <!-- 条件内容 -->
                                <div class="condition-content">
                                    <!-- 字段选择 -->
                                    <nz-form-item>
                                        <nz-select
                                            formControlName="field"
                                            nzPlaceHolder="请选择字段"
                                            nzShowSearch
                                            class="field-select"
                                        >
                                            <nz-option
                                                *ngFor="let field of availableFields"
                                                [nzValue]="field.id"
                                                [nzLabel]="field.name"
                                            ></nz-option>
                                        </nz-select>
                                    </nz-form-item>

                                    <!-- 操作符选择 -->
                                    <nz-form-item>
                                        <nz-select
                                            formControlName="operator"
                                            class="operator-select"
                                        >
                                            <nz-option
                                                *ngFor="let op of operators"
                                                [nzValue]="op.value"
                                                [nzLabel]="op.label"
                                            ></nz-option>
                                        </nz-select>
                                    </nz-form-item>

                                    <!-- 值输入 -->
                                    <nz-form-item class="value-input-container">
                                        <nz-select
                                            *ngIf="getFieldOptions(condition.get('field')?.value)?.length > 0"
                                            formControlName="value"
                                            nzPlaceHolder="请选择"
                                            nzShowSearch
                                            class="value-select"
                                        >
                                            <nz-option
                                                *ngFor="let option of getFieldOptions(condition.get('field')?.value)"
                                                [nzValue]="option.value"
                                                [nzLabel]="option.label"
                                            ></nz-option>
                                        </nz-select>

                                        <nz-input-group
                                            *ngIf="!getFieldOptions(condition.get('field')?.value)?.length"
                                            class="value-input"
                                        >
                                            <input
                                                nz-input
                                                formControlName="value"
                                                placeholder="请输入值"
                                            />
                                        </nz-input-group>
                                    </nz-form-item>
                                </div>
                            </div>

                            <!-- 添加条件按钮 -->
                            <button
                                nz-button
                                nzType="dashed"
                                nzSize="small"
                                (click)="addCondition(groupIndex)"
                                class="add-condition-btn"
                            >
                                <i nz-icon nzType="plus"></i>
                                添加条件
                            </button>
                        </div>
                    </nz-card>
                </div>
            </div>

            <!-- 添加条件组按钮 -->
            <div class="add-group-section">
                <button nz-button nzType="dashed"
                        (click)="addConditionGroup()" nzBlock>
                    <i nz-icon nzType="plus"></i>
                    添加条件组
                </button>
            </div>
        </div>
    </form>
</div>
