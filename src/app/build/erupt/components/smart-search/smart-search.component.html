<div class="smart-search-container">
    <div class="header-section">
        <div class="title-area">
            <h3 class="main-title">
                当满足以下条件时进入当前分支
            </h3>
            <button nz-button nzType="default" (click)="resetForm()" style="margin-left: auto">
                重置
            </button>
        </div>
    </div>
    <!-- 条件构建器 -->
    <form nz-form class="condition-builder">
        <div class="condition-panel">
            <!-- 条件组列表 -->
            <div class="condition-groups">
                <div
                    *ngFor="let group of search; let groupIndex = index"
                    class="condition-group-wrapper"
                >
                    <!-- 或标识 -->
                    <div class="or-divider" *ngIf="groupIndex > 0">
                        <span class="or-text">或</span>
                    </div>

                    <!-- 条件组卡片 -->
                    <nz-card
                        [nzTitle]="cardTitle"
                        [nzExtra]="cardExtra"
                        class="condition-group-card"
                        [nzSize]="'small'"
                    >
                        <ng-template #cardTitle>
                            <span class="card-title-text">条件组 {{ groupIndex + 1 }}</span>
                        </ng-template>

                        <ng-template #cardExtra>
                            <button nz-button nzType="text" nzSize="small" nzDanger
                                    (click)="removeConditionGroup(groupIndex)"
                                    *ngIf="!requiredHasCondition || search.length > 1"
                            >
                                <i nz-icon nzType="delete" nzTheme="outline"></i>
                            </button>
                        </ng-template>

                        <!-- 条件项列表 -->
                        <div class="conditions-list">
                            <div
                                *ngFor="let condition of group; let conditionIndex = index"
                                class="condition-item"
                            >
                                <!-- 逻辑操作符标签 -->
                                <div class="logic-label" *ngIf="conditionIndex > 0">
                                    <span class="logic-text">且</span>
                                    <button
                                        nz-button
                                        nzType="text"
                                        nzSize="small"
                                        nzDanger
                                        (click)="removeCondition(groupIndex, conditionIndex)"
                                    >
                                        <i nz-icon nzType="delete" nzTheme="outline"></i>
                                    </button>
                                </div>

                                <!-- 条件内容 -->
                                <div class="condition-content">
                                    <!-- 字段选择 -->
                                    <nz-form-item>
                                        <nz-select [(ngModel)]="condition.field"
                                                   (ngModelChange)="onFieldChange(condition)"
                                                   [ngModelOptions]="{standalone: true}"
                                                   nzPlaceHolder="请选择字段" nzShowSearch
                                                   class="field-select">
                                            <ng-container *ngFor="let field of eruptModel.eruptFieldModels">
                                                <ng-container *ngIf="searchTypeMapping[field.eruptFieldJson.edit.type] && field.eruptFieldJson.edit?.title">
                                                    <nz-option [nzValue]="field.fieldName" [nzLabel]="field.eruptFieldJson.edit.title"></nz-option>
                                                </ng-container>
                                            </ng-container>
                                        </nz-select>
                                    </nz-form-item>

                                    <!-- 操作符选择 -->
                                    <nz-form-item>
                                        <nz-select [(ngModel)]="condition.operator"
                                                   (ngModelChange)="onOperatorChange(condition)"
                                                   [ngModelOptions]="{standalone: true}"
                                                   class="operator-select">
                                            <ng-container [ngSwitch]="condition.operatorType">
                                                <ng-container *ngSwitchCase="OperatorType.STRING">
                                                    <nz-option
                                                        *ngFor="let op of OperatorStringType | enumToArray"
                                                        [nzValue]="op"
                                                        [nzLabel]="op | translate"
                                                    ></nz-option>
                                                </ng-container>
                                                <ng-container *ngSwitchCase="OperatorType.NUMBER">
                                                    <nz-option
                                                        *ngFor="let op of OperatorNumberType | enumToArray"
                                                        [nzValue]="op"
                                                        [nzLabel]="op | translate"
                                                    ></nz-option>
                                                </ng-container>
                                                <ng-container *ngSwitchCase="OperatorType.DATE">
                                                    <nz-option
                                                        *ngFor="let op of OperatorDateType | enumToArray"
                                                        [nzValue]="op"
                                                        [nzLabel]="op | translate"
                                                    ></nz-option>
                                                </ng-container>
                                                <ng-container *ngSwitchCase="OperatorType.BOOLEAN">
                                                    <nz-option
                                                        *ngFor="let op of OperatorReferenceType | enumToArray"
                                                        [nzValue]="op"
                                                        [nzLabel]="op | translate"
                                                    ></nz-option>
                                                </ng-container>
                                                <ng-container *ngSwitchCase="OperatorType.CHOICE">
                                                    <nz-option
                                                        *ngFor="let op of OperatorReferenceType | enumToArray"
                                                        [nzValue]="op"
                                                        [nzLabel]="op | translate"
                                                    ></nz-option>
                                                </ng-container>
                                                <ng-container *ngSwitchCase="OperatorType.REFERENCE">
                                                    <nz-option
                                                        *ngFor="let op of OperatorReferenceType | enumToArray"
                                                        [nzValue]="op"
                                                        [nzLabel]="op | translate"
                                                    ></nz-option>
                                                </ng-container>
                                            </ng-container>
                                        </nz-select>
                                    </nz-form-item>

                                    <!-- 值输入-->
                                    <div class="value-row" *ngIf="condition.operator">
                                        <nz-form-item class="value-input-container">
                                            <!-- 数字 -->
                                            <ng-container *ngIf="condition.operatorType === OperatorType.NUMBER">
                                                <ng-container *ngIf="
                                                  condition.operator === OperatorNumberType.EQ ||
                                                  condition.operator === OperatorNumberType.NEQ ||
                                                  condition.operator === OperatorNumberType.GT ||
                                                  condition.operator === OperatorNumberType.LT ||
                                                  condition.operator === OperatorNumberType.EGT ||
                                                  condition.operator === OperatorNumberType.ELT
                                            ">
                                                    <nz-input-number style="width: 100%" [ngModelOptions]="{standalone: true}"
                                                                     [(ngModel)]="condition.value">
                                                    </nz-input-number>
                                                </ng-container>

                                                <ng-container *ngIf="condition.operator === OperatorNumberType.RANGE">
                                                    <div style="display: flex; align-items: center; gap: 12px;width: 100%">
                                                        <nz-input-number style="flex: 1;" [ngModelOptions]="{standalone: true}"
                                                                        [(ngModel)]="condition.value[0]"
                                                                        placeholder="最小值">
                                                        </nz-input-number>
                                                        <span class="range-separator">至</span>
                                                        <nz-input-number style="flex: 1" [ngModelOptions]="{standalone: true}"
                                                                        [(ngModel)]="condition.value[1]"
                                                                        placeholder="最大值">
                                                        </nz-input-number>
                                                    </div>
                                                </ng-container>
                                            </ng-container>

                                            <!-- 文本 -->
                                            <ng-container *ngIf="condition.operatorType === OperatorType.STRING">
                                                <ng-container *ngIf=" condition.operator === OperatorStringType.EQ ||
                                                  condition.operator === OperatorStringType.NEQ        ||
                                                  condition.operator === OperatorStringType.NOT_LIKE   ||
                                                  condition.operator === OperatorStringType.LIKE       ||
                                                  condition.operator === OperatorStringType.START_WITH ||
                                                  condition.operator === OperatorStringType.END_WITH">
                                                    <input nz-input type="text" placeholder="请输入" [ngModelOptions]="{standalone: true}"
                                                           [(ngModel)]="condition.value">
                                                </ng-container>
                                                <ng-container *ngIf="
                                                  condition.operator === OperatorStringType.IN ||
                                                  condition.operator === OperatorStringType.NOT_IN
                                                ">
                                                    <nz-select [ngModelOptions]="{standalone: true}"
                                                               style="width: 100%"
                                                               nzMode="tags"
                                                               [nzPlaceHolder]="'请选择'"
                                                               [(ngModel)]="condition.value" [nzOptions]="[]">
                                                    </nz-select>
                                                </ng-container>
                                            </ng-container>

                                            <!-- 时间 -->
                                            <ng-container *ngIf="condition.operatorType === OperatorType.DATE">
                                                <ng-container *ngIf="(
                                                    condition.operator === OperatorDateType.GT ||
                                                    condition.operator === OperatorDateType.LT ||
                                                    condition.operator === OperatorDateType.EGT ||
                                                    condition.operator === OperatorDateType.ELT
                                                )">
                                                    <nz-date-picker style="width: 100%" [ngModelOptions]="{standalone: true}"
                                                                    [(ngModel)]="condition.value"></nz-date-picker>
                                                </ng-container>
                                                <ng-container *ngIf="condition.operator === OperatorDateType.RANGE">
                                                    <nz-range-picker style="width: 100%" [nzShowTime]="true" [(ngModel)]="condition.value"></nz-range-picker>
                                                </ng-container>
                                                <ng-container *ngIf="condition.operator === OperatorDateType.FEW_DAYS || condition.operator === OperatorDateType.FUTURE_DAYS">
                                                    <nz-input-number style="width: 100%" [ngModelOptions]="{standalone: true}"
                                                                     [(ngModel)]="condition.value" [nzMin]="0">
                                                    </nz-input-number>
                                                </ng-container>
                                            </ng-container>
                                            <!-- 布尔值 -->
                                            <ng-container *ngIf="condition.operatorType === OperatorType.BOOLEAN">
                                                <nz-select [ngModelOptions]="{standalone: true}"
                                                           style="width: 100%"
                                                           [nzPlaceHolder]="'请选择'"
                                                           [(ngModel)]="condition.value">
                                                    <nz-option [nzValue]="true" [nzLabel]="eruptModel.eruptFieldModelMap.get(condition.field).eruptFieldJson.edit.boolType.trueText"></nz-option>
                                                    <nz-option [nzValue]="false" [nzLabel]="eruptModel.eruptFieldModelMap.get(condition.field).eruptFieldJson.edit.boolType.falseText"></nz-option>
                                                </nz-select>
                                            </ng-container>
                                            <!-- 选择 -->
                                            <ng-container *ngIf="condition.operatorType === OperatorType.CHOICE">
                                                <ng-container *ngIf="condition.operator === OperatorReferenceType.EQ || condition.operator === OperatorReferenceType.NEQ">
                                                    <nz-select [ngModelOptions]="{standalone: true}"
                                                               style="width: 100%"
                                                               nzMode="multiple"
                                                               [nzPlaceHolder]="'请选择'"
                                                               [(ngModel)]="condition.value">
                                                        <nz-option *ngFor="let item of eruptModel.eruptFieldModelMap.get(condition.field).componentValue"
                                                                   [nzValue]="item.value" [nzLabel]="item.label">

                                                        </nz-option>
                                                    </nz-select>
                                                </ng-container>
                                            </ng-container>
                                            <ng-container *ngIf="condition.operatorType === OperatorType.REFERENCE">
                                                <ng-container *ngIf="condition.operator === OperatorReferenceType.EQ || condition.operator === OperatorReferenceType.NEQ">
                                                    <erupt-reference style="width: 100%" [eruptModel]="eruptModel" [field]="eruptModel.eruptFieldModelMap.get(condition.field)" [size]="'default'"
                                                                     [readonly]="false"></erupt-reference>
                                                </ng-container>
                                            </ng-container>
                                        </nz-form-item>
                                    </div>
                                </div>
                            </div>

                            <!-- 添加条件按钮 -->
                            <button
                                nz-button
                                nzType="dashed"
                                nzSize="small"
                                (click)="addCondition(groupIndex)"
                                class="add-condition-btn"
                            >
                                <i nz-icon nzType="plus"></i>
                                添加条件
                            </button>
                        </div>
                    </nz-card>
                </div>
            </div>

            <!-- 添加条件组按钮 -->
            <div class="add-group-section">
                <button nz-button nzType="dashed"
                        (click)="addConditionGroup()" nzBlock>
                    <i nz-icon nzType="plus"></i>
                    添加条件组
                </button>
            </div>
        </div>
    </form>
</div>
