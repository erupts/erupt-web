<div class="smart-search-container">
    <div class="header-section">
        <div class="title-area">
            <h3 class="main-title">
                当满足以下条件时进入当前分支
            </h3>
            <button nz-button nzType="default" (click)="resetForm()" style="margin-left: auto">
                重置
            </button>
        </div>
    </div>
    <!-- 条件构建器 -->
    <form nz-form class="condition-builder">
        <div class="condition-panel">
            <!-- 条件组列表 -->
            <div class="condition-groups">
                <div
                    *ngFor="let group of search; let groupIndex = index"
                    class="condition-group-wrapper"
                >
                    <!-- 或标识 -->
                    <div class="or-divider" *ngIf="groupIndex > 0">
                        <span class="or-text">或</span>
                    </div>

                    <!-- 条件组卡片 -->
                    <nz-card
                        [nzTitle]="cardTitle"
                        [nzExtra]="cardExtra"
                        class="condition-group-card"
                        [nzSize]="'small'"
                    >
                        <ng-template #cardTitle>
                            <span class="card-title-text">条件组 {{ groupIndex + 1 }}</span>
                        </ng-template>

                        <ng-template #cardExtra>
                            <button nz-button nzType="text" nzSize="small" nzDanger
                                (click)="removeConditionGroup(groupIndex)"
                                *ngIf="!requiredHasCondition || search.length > 1"
                            >
                                <i nz-icon nzType="delete" nzTheme="outline"></i>
                            </button>
                        </ng-template>

                        <!-- 条件项列表 -->
                        <div class="conditions-list">
                            <div
                                *ngFor="let condition of group; let conditionIndex = index"
                                class="condition-item"
                            >
                                <!-- 逻辑操作符标签 -->
                                <div class="logic-label" *ngIf="conditionIndex > 0">
                                    <span class="logic-text">且</span>
                                    <button
                                        nz-button
                                        nzType="text"
                                        nzSize="small"
                                        nzDanger
                                        (click)="removeCondition(groupIndex, conditionIndex)"
                                    >
                                        <i nz-icon nzType="delete" nzTheme="outline"></i>
                                    </button>
                                </div>

                                <!-- 条件内容 -->
                                <div class="condition-content">
                                    <!-- 字段选择 -->
                                    <nz-form-item>
                                        <nz-select [(ngModel)]="search[groupIndex][conditionIndex].field"
                                                   (ngModelChange)="onFieldChange(groupIndex, conditionIndex)"
                                                   [ngModelOptions]="{standalone: true}"
                                                   nzPlaceHolder="请选择字段" nzShowSearch
                                                   class="field-select">
                                            <ng-container *ngFor="let field of eruptModel.eruptFieldModels">
                                                <nz-option
                                                    *ngIf="field.eruptFieldJson.edit?.title"
                                                    [nzValue]="field.fieldName"
                                                    [nzLabel]="field.eruptFieldJson.edit.title"
                                                ></nz-option>
                                            </ng-container>
                                        </nz-select>
                                    </nz-form-item>

                                    <!-- 操作符选择 -->
                                    <nz-form-item>
                                        <nz-select [(ngModel)]="search[groupIndex][conditionIndex].operator"
                                                   [ngModelOptions]="{standalone: true}"
                                                   class="operator-select">

                                            <nz-option
                                                *ngFor="let op of getOperator(search[groupIndex][conditionIndex].field)"
                                                [nzValue]="op.value"
                                                [nzLabel]="op.label"
                                            ></nz-option>
                                        </nz-select>
                                    </nz-form-item>

                                    <!-- 值输入-->
                                    <div class="value-row" *ngIf="search[groupIndex][conditionIndex].operator">
                                        <nz-form-item class="value-input-container">
                                            <!-- 数字输入（天数/数值） -->
                                            <ng-container *ngIf="
                                              search[groupIndex][conditionIndex].operator === 'FUTURE_DAYS' ||
                                              search[groupIndex][conditionIndex].operator === 'FEW_DAYS'   ||
                                              search[groupIndex][conditionIndex].operator === 'GT'         ||
                                              search[groupIndex][conditionIndex].operator === 'LT'         ||
                                              search[groupIndex][conditionIndex].operator === 'EGT'        ||
                                              search[groupIndex][conditionIndex].operator === 'ELT'
                                            ">
                                                <nz-input-number style="width: 100%" [ngModelOptions]="{standalone: true}"
                                                                 [(ngModel)]="search[groupIndex][conditionIndex].value"
                                                                 [nzMin]="0">
                                                </nz-input-number>
                                            </ng-container>

                                            <!-- 普通文本输入 -->
                                            <ng-container *ngIf="
                                              search[groupIndex][conditionIndex].operator === 'EQ'        ||
                                              search[groupIndex][conditionIndex].operator === 'NEQ'       ||
                                              search[groupIndex][conditionIndex].operator === 'LIKE'      ||
                                              search[groupIndex][conditionIndex].operator === 'NOT_LIKE'  ||
                                              search[groupIndex][conditionIndex].operator === 'START_WITH'||
                                              search[groupIndex][conditionIndex].operator === 'END_WITH'
                                            ">
                                                <input nz-input type="text" placeholder="请输入" [ngModelOptions]="{standalone: true}"
                                                       [(ngModel)]="search[groupIndex][conditionIndex].value">
                                            </ng-container>
                                            <!-- 区间选择器（RANGE） -->
                                            <ng-container *ngIf="search[groupIndex][conditionIndex].operator === 'RANGE'">
                                                <nz-range-picker style="width: 100%" [nzShowTime]="true" [(ngModel)]="search[groupIndex][conditionIndex].value"></nz-range-picker>
                                            </ng-container>
                                            <!-- 多选下拉（IN / NOT_IN） -->
                                            <ng-container *ngIf="
                                              search[groupIndex][conditionIndex].operator === 'IN' ||
                                              search[groupIndex][conditionIndex].operator === 'NOT_IN'
                                            ">
                                                <nz-select [ngModelOptions]="{standalone: true}"
                                                    style="width: 100%"
                                                    nzMode="tags"
                                                    [nzPlaceHolder]="'请选择'"
                                                    [(ngModel)]="search[groupIndex][conditionIndex].value">
                                                </nz-select>
                                            </ng-container>
                                        </nz-form-item>
                                    </div>
                                </div>
                            </div>

                            <!-- 添加条件按钮 -->
                            <button
                                nz-button
                                nzType="dashed"
                                nzSize="small"
                                (click)="addCondition(groupIndex)"
                                class="add-condition-btn"
                            >
                                <i nz-icon nzType="plus"></i>
                                添加条件
                            </button>
                        </div>
                    </nz-card>
                </div>
            </div>

            <!-- 添加条件组按钮 -->
            <div class="add-group-section">
                <button nz-button nzType="dashed"
                        (click)="addConditionGroup()" nzBlock>
                    <i nz-icon nzType="plus"></i>
                    添加条件组
                </button>
            </div>
        </div>
    </form>
</div>
